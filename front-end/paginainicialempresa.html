<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Minhas Vagas Criadas</title>
  <link rel="stylesheet" href="./CSS/style.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="./CSS/navega√ßao.css" />
  <link rel="icon" type="image/x-icon" href="./CSS/imagens/iconedosite.png" />
  <style>
    /* Pequenos ajustes para visual */
    .textovagas { margin-top: 10px; margin-bottom: 20px; }
    .card-img-top { height: 160px; object-fit: cover; background:#f3f3f3; }
    .borda { height: 6px; background:#0d6efd; }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="borda"></div>
    <ul>
      <li class="drop">
        <button class="botaodrop" style="height:50px;width:60px;">
          <img style="height:20px;width:30px;" src="./CSS/imagens/tracos.png" alt="Menu">
        </button>
        <div class="dropconteudo">
          <div style="height:40px"></div>
          <a href="./verperfil.html">Ver Perfil</a>
          <a href="">Painel</a>
          <a href="./mensagens.html">Mensagens</a>
          <a href="./contatos.html">Notifica√ß√µes</a>
          <a href="./configura√ß√µes.html">Configura√ß√µes</a>
          <a id="btnLogout" style="cursor:pointer;color:white;">Sair</a>
        </div>
      </li>

      <img style="float:left;height:90px;width:90px;border-radius:250px;margin-left:20px;margin-top:20px;" src="./CSS/imagens/iconedosite.png" alt="logo">
      <li><input class="pesquisa" type="text" id="search-input" placeholder="Pesquisar"></li>
      <li><button class="btn btn-secondary" id="toggle-dark-mode" style="height:40px;width:40px;border-radius:50%;">üåô</button></li>
    </ul>
  </header>

  <!-- Main -->
  <section class="vaga-container py-5">
    <div class="container">
      <h2 class="textovagas">Minhas Vagas Criadas</h2>

      <!-- Criar Vaga (s√≥ vis√≠vel para empresas - controlado via JS) -->
      <div class="mb-3">
        <button id="btnAbrirCriar" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalCriarVaga">
          ‚ûï Criar Nova Vaga
        </button>
      </div>

      <!-- Filtros -->
      <div class="row mb-4">
        <div class="col-md-4">
          <input type="text" class="form-control" id="search-cargo" placeholder="Buscar por cargo ou empresa">
        </div>
        <div class="col-md-4">
          <select class="form-select" id="search-localizacao">
            <option selected>Selecione uma localiza√ß√£o</option>
            <option value="S√£o Paulo">S√£o Paulo</option>
            <option value="Rio de Janeiro">Rio de Janeiro</option>
            <option value="Curitiba">Curitiba</option>
            <option value="Salvador">Salvador</option>
            <option value="Belo Horizonte">Belo Horizonte</option>
          </select>
        </div>
      </div>

      <!-- Lista -->
      <div class="row g-4" id="vaga-container"></div>
    </div>
  </section>

  <!-- Modal Criar Vaga -->
  <div class="modal fade" id="modalCriarVaga" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Criar Nova Vaga</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <form id="formCriarVaga">
            <label class="form-label">√Årea de trabalho</label>
            <input class="form-control mb-2" name="titulo" placeholder="Ex: Auxiliar Administrativo" required>

            <label class="form-label">Sal√°rio (pre√ßo)</label>
            <input class="form-control mb-2" name="salario" placeholder="Ex: 2500" type="number" step="0.01" required>

            <label class="form-label">Categoria (√°rea)</label>
            <!-- Op√ß√µes baseadas nas suas inser√ß√µes no banco (id 1..8) -->
            <select class="form-select mb-2" name="id_categoria">
              <option value="1">1 - Produ√ß√£o</option>
              <option value="2">2 - Log√≠stica</option>
              <option value="3">3 - Manuten√ß√£o</option>
              <option value="4">4 - Qualidade</option>
              <option value="5">5 - Almoxarifado</option>
              <option value="6">6 - Recursos Humanos</option>
              <option value="7">7 - Engenharia de Processos</option>
              <option value="8">8 - Opera√ß√µes</option>
            </select>

            <label class="form-label">Descri√ß√£o (opcional)</label>
            <textarea class="form-control mb-2" name="descricao" placeholder="Descri√ß√£o curta (n√£o necess√°ria para o DB)"></textarea>

            <label class="form-label">PCD?</label>
            <select class="form-select mb-2" name="pcd">
              <option value="0">N√£o √© PCD</option>
              <option value="1">Vaga para PCD</option>
            </select>
          </form>

          <div id="msg-criar" class="mt-2"></div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnSalvarVaga">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Detalhes -->
  <div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalDetalhesLabel">Detalhes da Vaga</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="row">
            <div class="col-md-5">
              <img id="modal-imagem" class="img-fluid" alt="Imagem Vaga" src="https://cdn.pixabay.com/photo/2015/01/08/18/25/desk-593327_1280.jpg">
            </div>
            <div class="col-md-7">
              <h4 id="modal-titulo"></h4>
              <p><strong>Descri√ß√£o:</strong> <span id="modal-descricao"></span></p>
              <p><strong>Localiza√ß√£o:</strong> <span id="modal-localizacao"></span></p>
              <p><strong>Tipo:</strong> <span id="modal-tipo"></span></p>
              <p><strong>Empresa:</strong> <span id="modal-contato"></span></p>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="mt-5">
    <div class="rodape text-center py-3">
      <p>&copy; 2025 FusionDevs. Todos os direitos reservados.</p>
      <p>Informa√ß√µes de contato: <a href="mailto:contato@suaempresa.com">contato@suaempresa.com</a></p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script src="./js/darkmode.js"></script>

 <script>
// ===== CONFIG =====
const ROUTE_LIST = "https://faithful-spirit-teste1.up.railway.app/tcc/busca_Vaga";
const ROUTE_CREATE = "https://faithful-spirit-teste1.up.railway.app/tcc/add_vaga";

// ====== VERIFICA LOGIN ======
document.addEventListener("DOMContentLoaded", () => {

    const token = localStorage.getItem("jwtToken");
    let usuario = null;

    try {
        usuario = JSON.parse(localStorage.getItem("usuario"));
    } catch {
        usuario = null;
    }

    console.log("TOKEN:", token);
    console.log("USUARIO:", usuario);

    const tipo = usuario?.tipo || null;

    console.log("TIPO IDENTIFICADO:", tipo);

    if (!token || !usuario || tipo !== "empresa") {
        alert("Voc√™ precisa estar logado como empresa para criar vagas.");
        window.location.href = "./login.html";
        return;
    }

    ajustarInterfacePorToken();
    carregarVagas();
});

// ===== HELPERS =====
function parseJwt(token) {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    } catch {
        return null;
    }
}

function isEmpresaToken(jwtToken) {
    const payload = parseJwt(jwtToken);
    return payload && payload.tipo === "empresa";
}

// ===== DOM refs =====
const container = document.getElementById('vaga-container');
const form = document.getElementById('formCriarVaga');
const msgCriar = document.getElementById('msg-criar');
const btnSalvarVaga = document.getElementById('btnSalvarVaga');
const btnAbrirCriar = document.getElementById('btnAbrirCriar');

// ===== AJUSTE DE BOT√ïES POR TOKEN =====
function ajustarInterfacePorToken() {
    const token = localStorage.getItem("jwtToken");
    
    if (btnAbrirCriar) {
        if (token && isEmpresaToken(token)) {
            btnAbrirCriar.style.display = "inline-block";
        } else {
            btnAbrirCriar.style.display = "none";
        }
    }

    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
        btnLogout.onclick = () => {
            localStorage.removeItem("jwtToken");
            localStorage.removeItem("usuario");
            alert("Deslogado.");
            window.location.href = "./login.html";
        };
    }
}

// ===== CARREGAR VAGAS =====
async function carregarVagas() {
    container.innerHTML = '<div class="text-center py-4">Carregando vagas...</div>';
    try {
        const res = await fetch(ROUTE_LIST);
        if (!res.ok) throw new Error("Resposta n√£o OK: " + res.status);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML = `<p style="color:red; font-weight:bold;">Nenhuma vaga cadastrada no sistema.</p>`;
            return;
        }

        vagas = data.map(v => ({
            id: v.id_vaga ?? v.id,
            titulo: v.nome ?? v.area_de_trabalho ?? 'Vaga',
            empresa: v.nome_empresa ?? v.nome ?? '‚Äî',
            salario: v.preco ?? v.salario ?? 0,
            cidade: v.cidade_empresa ?? '',
            estado: v.estado_empresa ?? '',
            is_pcd: Boolean(v.is_pcd),
            descricao: v.descricao ?? '',
            imagem: v.imagem ?? "./css/imagens/Designer.png",
            tipoTrabalho: v.tipoTrabalho ?? "Tempo Integral"
        }));

        criarCards(vagas);

    } catch (err) {
        console.error(err);
        container.innerHTML = `<p style="color:red;">Erro ao carregar vagas.</p>`;
    }
}

// ===== CRIAR CARDS =====
function criarCards(lista) {
    container.innerHTML = '';
    if (!lista.length) {
        container.innerHTML = `<p style="color:#666;">Nenhuma vaga dispon√≠vel.</p>`;
        return;
    }

    lista.forEach((vaga, idx) => {
        const div = document.createElement('div');
        div.className = 'col-md-4 mb-4';

        div.innerHTML = `
            <div class="card shadow-sm h-100">
                <img src="${vaga.imagem}" class="card-img-top">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${vaga.titulo}</h5>
                    <p><strong>Empresa:</strong> ${vaga.empresa}</p>
                    <p><strong>Local:</strong> ${vaga.cidade} - ${vaga.estado}</p>
                    <p><strong>Sal√°rio:</strong> R$ ${Number(vaga.salario).toLocaleString('pt-BR')}</p>
                    ${vaga.is_pcd ? '<span class="badge bg-success mb-2">PCD</span>' : ''}
                    <button class="btn btn-primary mt-auto" onclick="mostrarDetalhesVaga(${idx})">Detalhes</button>
                </div>
            </div>
        `;
        container.appendChild(div);
    });
}

// ===== MOSTRAR DETALHES =====
function mostrarDetalhesVaga(i) {
    const v = vagas[i];
    document.getElementById("modal-titulo").innerText = v.titulo;
    document.getElementById("modal-descricao").innerText = v.descricao;
    document.getElementById("modal-localizacao").innerText = `${v.cidade} - ${v.estado}`;
    document.getElementById("modal-tipo").innerText = v.tipoTrabalho;
    document.getElementById("modal-contato").innerText = v.empresa;
    document.getElementById("modal-imagem").src = v.imagem;

    new bootstrap.Modal(document.getElementById("modalDetalhes")).show();
}

// ===== CRIAR VAGA =====
async function criarVaga() {
    msgCriar.innerHTML = '';
    const token = localStorage.getItem("jwtToken");

    if (!token) {
        alert("Voc√™ precisa estar logado como empresa.");
        return;
    }

    const formData = new FormData(form);

    const payload = {
    nome: formData.get("titulo"),
    salario: Number(formData.get("salario")),
    id_categoria: Number(formData.get("id_categoria")),
    descricao: formData.get("descricao") || "",
    is_pcd: formData.get("pcd") === "1"
};



    try {
        const res = await fetch(ROUTE_CREATE, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (data.sucesso) {
            msgCriar.innerHTML = `<span style="color:green;">Vaga criada com sucesso!</span>`;
            form.reset();
            bootstrap.Modal.getInstance(document.getElementById("modalCriarVaga")).hide();
            carregarVagas();
        } else {
            msgCriar.innerHTML = `<span style="color:red;">Erro: ${data.mensagem}</span>`;
        }

    } catch {
        msgCriar.innerHTML = `<span style="color:red;">Erro ao criar vaga.</span>`;
    }
}

btnSalvarVaga.addEventListener("click", (e) => {
    e.preventDefault();
    criarVaga();
});
</script>

</body>
</html>
